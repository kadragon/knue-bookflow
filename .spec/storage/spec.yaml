spec_id: SPEC-storage-001
title: "D1 Database Storage"
description: |
  Store borrowed book records and metadata in Cloudflare D1
  for future reading notes and history tracking.

given_when_then:
  - given: "New book is borrowed and info is retrieved"
    when: "Save operation is called"
    then: "Book record is inserted into D1 database"

  - given: "Book with same ISBN already exists for same charge"
    when: "Save operation is called"
    then: "Duplicate is prevented, existing record updated if needed"

  - given: "Renewal is successful"
    when: "Update operation is called"
    then: "Book record dueDate and renewCnt are updated"

  - given: "Query for book history is made"
    when: "Find operation is called"
    then: "Matching records are returned"

acceptance_tests:
  - id: TEST-storage-001
    desc: "Insert new book record into D1"
  - id: TEST-storage-002
    desc: "Prevent duplicate entries for same charge"
  - id: TEST-storage-003
    desc: "Update existing record on renewal"
  - id: TEST-storage-004
    desc: "Query books by various criteria"
  - id: TEST-storage-005
    desc: "Handle D1 connection errors gracefully"

technical_notes:
  tables:
    books:
      columns:
        - id: INTEGER PRIMARY KEY
        - charge_id: TEXT UNIQUE
        - isbn: TEXT
        - title: TEXT
        - author: TEXT
        - publisher: TEXT
        - cover_url: TEXT
        - description: TEXT
        - charge_date: DATE
        - due_date: DATE
        - renew_count: INTEGER
        - created_at: DATETIME
        - updated_at: DATETIME

    renewal_logs:
      columns:
        - id: INTEGER PRIMARY KEY
        - charge_id: TEXT
        - action: TEXT
        - status: TEXT
        - message: TEXT
        - created_at: DATETIME

dependencies:
  - governance: "env.yaml"

linked_tasks:
  - TASK-006
