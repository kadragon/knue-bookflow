spec_id: SPEC-sync-001
title: "Library-DB Sync"
description: |
  Synchronize all currently borrowed books from the library with the D1 database.
  This ensures books that were missed during daily sync (due to errors or timing)
  are properly registered with Aladin metadata.

given_when_then:
  - given: "User triggers sync operation"
    when: "Sync API is called"
    then: "All current library charges are fetched and compared with DB"

  - given: "Library has books not in DB"
    when: "Sync operation runs"
    then: "Missing books are added with Aladin metadata enrichment"

  - given: "Library has books already in DB"
    when: "Sync operation runs"
    then: "Existing books are updated with latest due_date and renew_count"

  - given: "Book ISBN is available"
    when: "New book is added during sync"
    then: "Aladin API is queried for metadata (publisher, cover, description)"

  - given: "Sync completes"
    when: "Operation finishes"
    then: "Summary of added/updated books is returned"

acceptance_tests:
  - id: TEST-sync-001
    desc: "Fetch all charges from library API"
  - id: TEST-sync-002
    desc: "Identify books missing from DB"
  - id: TEST-sync-003
    desc: "Add missing books with Aladin metadata"
  - id: TEST-sync-004
    desc: "Update existing books with latest charge data"
  - id: TEST-sync-005
    desc: "Return sync summary (added/updated counts)"
  - id: TEST-sync-006
    desc: "Handle library API errors gracefully"

api_contract:
  endpoint: "POST /api/books/sync"
  request_body: null  # No body required - uses env credentials
  response:
    success:
      status: 200
      body:
        message: string
        summary:
          total_charges: number
          added: number
          updated: number
          unchanged: number
    error:
      status: 500
      body:
        error: string

dependencies:
  - spec: SPEC-storage-001
  - spec: SPEC-auth-001
  - spec: SPEC-charges-001
  - service: library-client.ts
  - service: aladin-client.ts
  - service: book-repository.ts

linked_tasks:
  - TASK-021
