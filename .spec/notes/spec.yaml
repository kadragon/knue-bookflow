spec_id: SPEC-notes-002
title: "Note persistence and management"
description: |
  Full note-taking feature for books with persistence to D1 database.
  Users can create, read, update, and delete notes for each book.
  Notes are displayed in page order with quote-style formatting in a modal.

given_when_then:
  # Backend - API
  - given: "A user requests GET /api/books/:id/notes"
    when: "The book exists and has notes"
    then: "Returns all notes for the book sorted by page_number ascending"

  - given: "A user requests GET /api/books/:id/notes"
    when: "The book exists but has no notes"
    then: "Returns an empty array"

  - given: "A user sends POST /api/books/:id/notes with page_number and content"
    when: "The request is valid"
    then: "Creates a new note and returns the created note with id"

  - given: "A user sends PUT /api/notes/:id with updated content or page_number"
    when: "The note exists"
    then: "Updates the note and returns the updated note"

  - given: "A user sends DELETE /api/notes/:id"
    when: "The note exists"
    then: "Deletes the note and returns success status"

  # Frontend - UI
  - given: "A user clicks the note button on a book card"
    when: "The modal opens"
    then: "Shows all notes for that book in page order with quote styling"

  - given: "A user is viewing the notes modal"
    when: "They click 'Add Note'"
    then: "Shows a form with page number input and content textarea"

  - given: "A user submits the note form"
    when: "Both page_number and content are provided"
    then: "Creates the note and refreshes the note list"

  - given: "A user clicks edit on an existing note"
    when: "The edit form opens"
    then: "Pre-fills the form with existing page_number and content"

  - given: "A user clicks delete on a note"
    when: "Confirmation is given"
    then: "Deletes the note and refreshes the list"

acceptance_tests:
  # Database
  - id: TEST-notes-db-001
    desc: "Notes table exists with correct schema (id, book_id, page_number, content, timestamps)"

  # Repository
  - id: TEST-notes-repo-001
    desc: "findByBookId returns notes sorted by page_number"
  - id: TEST-notes-repo-002
    desc: "create inserts a new note and returns it with id"
  - id: TEST-notes-repo-003
    desc: "update modifies existing note"
  - id: TEST-notes-repo-004
    desc: "delete removes note from database"

  # API
  - id: TEST-notes-api-001
    desc: "GET /api/books/:id/notes returns notes array sorted by page"
  - id: TEST-notes-api-002
    desc: "POST /api/books/:id/notes creates note with valid data"
  - id: TEST-notes-api-003
    desc: "POST /api/books/:id/notes returns 400 for invalid data"
  - id: TEST-notes-api-004
    desc: "PUT /api/notes/:id updates note"
  - id: TEST-notes-api-005
    desc: "DELETE /api/notes/:id removes note"

  # UI
  - id: TEST-notes-ui-001
    desc: "Note modal opens when clicking note button"
  - id: TEST-notes-ui-002
    desc: "Notes display in page order with quote styling"
  - id: TEST-notes-ui-003
    desc: "Add note form validates required fields"
  - id: TEST-notes-ui-004
    desc: "Edit note pre-fills form with existing values"
  - id: TEST-notes-ui-005
    desc: "Delete note shows confirmation before removing"
  - id: TEST-notes-ui-006
    desc: "Note creation control appears before the note list so new entries are reachable without scrolling"
  - id: TEST-notes-ui-007
    desc: "Book card note CTA hides the '(작성 예정)' placeholder when no notes exist"

technical_notes:
  database_schema: |
    CREATE TABLE notes (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      book_id INTEGER NOT NULL,
      page_number INTEGER NOT NULL,
      content TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
    );
    CREATE INDEX idx_notes_book_id ON notes(book_id);

  api_endpoints:
    - method: GET
      path: /api/books/:id/notes
      response: "{ notes: Note[] }"
    - method: POST
      path: /api/books/:id/notes
      body: "{ page_number: number, content: string }"
      response: "{ note: Note }"
    - method: PUT
      path: /api/notes/:id
      body: "{ page_number?: number, content?: string }"
      response: "{ note: Note }"
    - method: DELETE
      path: /api/notes/:id
      response: "{ success: boolean }"

  ui_design: |
    Modal with dark theme matching existing styles.
    Notes displayed as blockquotes with page number badges.
    Form uses consistent input styling from existing filters.

dependencies:
  - SPEC-notes-001  # Stub implementation
  - SPEC-storage-001  # D1 database

linked_tasks:
  - TASK-023
