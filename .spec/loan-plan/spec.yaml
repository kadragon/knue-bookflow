spec_id: SPEC-loan-plan-001
title: "Planned Loans from Search & New Books"
description: |
  Allow users to save library catalog items they want to borrow later. Items can be added
  from both the New Books list and the Library Search results, are stored in D1 as
  "대출 예정" entries with core metadata (title, author, publisher, year, ISBN, cover,
  branch volumes), and can be reviewed or removed in a dedicated planned-loans view.

given_when_then:
  - given: "User sees a book card in New Books or Search results"
    when: "User clicks the + (대출 예정) action"
    then: "The item is persisted as a planned loan with normalized metadata; UI shows success without page reload"

  - given: "The same catalog item is already stored as a planned loan"
    when: "User clicks + again from any source"
    then: "API rejects with a conflict response and UI surfaces a non-destructive notice (no duplicates)"

  - given: "Planned loans exist in D1"
    when: "User opens the Planned Loans view"
    then: "Items are listed newest-first with title/author/publisher/year/ISBN, branch availability info, and a remove control"

  - given: "User no longer needs a planned item"
    when: "User clicks remove on the item"
    then: "The item is deleted from D1 and disappears from the list"

  - given: "Client sends malformed planned-loan payload"
    when: "POST /api/planned-loans receives missing/invalid required fields"
    then: "API responds 400 with validation message"

acceptance_tests:
  - id: TEST-loan-plan-001
    desc: "POST /api/planned-loans validates payload, deduplicates by libraryId, and stores a new entry"

  - id: TEST-loan-plan-002
    desc: "GET /api/planned-loans returns planned items sorted by created_at with parsed branchVolumes"

  - id: TEST-loan-plan-003
    desc: "DELETE /api/planned-loans/:id removes the entry and is idempotent for missing ids"

  - id: TEST-loan-plan-004
    desc: "SearchBooksPage and NewBooksPage render + actions that call the planned-loan API and surface success/conflict errors"

  - id: TEST-loan-plan-005
    desc: "Planned Loans page shows list/empty state and remove control updates the view"

dependencies:
  - governance: "coding-style"
  - governance: "memory.md"
  - spec: SPEC-frontend-001
  - spec: SPEC-search-001

linked_tasks:
  - TASK-043
