spec_id: SPEC-scheduler-001
title: "Manual Workflow Trigger"
description: |
  Run the renewal workflow only when explicitly triggered (UI or POST /trigger).
  The scheduled handler is reserved for the daily note broadcast.

given_when_then:
  - given: "User presses the manual '갱신' button"
    when: "Frontend issues POST /trigger"
    then: "Workflow starts in background and response returns immediately"

  - given: "Manual trigger is invoked"
    when: "Workflow runs"
    then: "Login, fetch charges, process renewals, sync records, mark returns, log summary"

  - given: "Scheduled cron fires for note broadcast"
    when: "Handler receives NOTE_BROADCAST_CRON"
    then: "Note broadcast runs and renewal workflow is not started"

  - given: "Scheduled handler receives an unknown cron"
    when: "No matching cron is found"
    then: "Handler logs and skips renewal workflow"

acceptance_tests:
  - id: TEST-scheduler-001
    desc: "Manual trigger starts the workflow and responds immediately"
  - id: TEST-scheduler-002
    desc: "Note broadcast cron does not start renewal workflow"
  - id: TEST-scheduler-003
    desc: "Workflow executes steps in correct order"
  - id: TEST-scheduler-004
    desc: "Errors are logged and workflow aborts safely"
  - id: TEST-scheduler-005
    desc: "Header exposes a single manual refresh control (no duplicate refresh icon)"

technical_notes:
  manual_trigger: "POST /trigger (Zero Trust protected)"
  note_broadcast_cron: "0 3 * * *"

dependencies:
  - spec: "SPEC-renewal-001"
  - spec: "SPEC-notes-telegram-001"
  - spec: "SPEC-storage-001"

linked_tasks:
  - TASK-007
  - TASK-070
