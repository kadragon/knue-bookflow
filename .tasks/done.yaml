# Completed Tasks
# Tasks are moved here after completion with results and learnings

completed_tasks:
  - task_id: TASK-001
    title: "Initialize Cloudflare Workers project"
    completed_at: "unknown"
    outcome: success
    spec_id: null
    summary: "Completed prior to detailed tracking; project scaffold and Wrangler/TypeScript setup established."
    learnings:
      - "Initial setup finished before current records; see early repo history for specifics."

  - task_id: TASK-002
    title: "Implement library authentication module"
    completed_at: "unknown"
    outcome: success
    spec_id: SPEC-auth-001
    summary: "Authentication workflow implemented prior to current tracking; handles Pyxis login/session."
    learnings:
      - "Original auth implementation predates current notes; covered by later resilience upgrades."

  - task_id: TASK-003
    title: "Implement charges retrieval service"
    completed_at: "unknown"
    outcome: success
    spec_id: SPEC-charges-001
    summary: "Charges retrieval delivered before detailed notes; forms basis for sync/renewal flows."
    learnings:
      - "Pagination/retry behavior later improved under TASK-014."

  - task_id: TASK-004
    title: "Implement book renewal logic"
    completed_at: "unknown"
    outcome: success
    spec_id: SPEC-renewal-001
    summary: "Initial renewal logic shipped earlier; later corrected for persistence and timezone."
    learnings:
      - "Subsequent tasks addressed renewal data freshness and KST handling."

  - task_id: TASK-005
    title: "Implement Aladin API integration"
    completed_at: "unknown"
    outcome: success
    spec_id: SPEC-bookinfo-001
    summary: "Initial Aladin integration completed before current logs; later enhanced for cover sizing."
    learnings:
      - "Cover size and refresh behavior refined in TASK-032."

  - task_id: TASK-006
    title: "Set up D1 database and repository"
    completed_at: "unknown"
    outcome: success
    spec_id: SPEC-storage-001
    summary: "Base D1 schema and repository were delivered before detailed tracking began."
    learnings:
      - "Later tasks expanded schema with notes, send stats, and return tracking."

  - task_id: TASK-007
    title: "Implement scheduled workflow handler"
    completed_at: "unknown"
    outcome: success
    spec_id: SPEC-scheduler-001
    summary: "Cron orchestration built prior to current notes; later secured and branched for new crons."
    learnings:
      - "Security shifted to Zero Trust in TASK-016."

  - task_id: TASK-008
    title: "Add TypeScript type definitions"
    completed_at: "2025-11-22T20:20:00Z"
    outcome: success
    spec_id: null
    summary: |
      Consolidated and enhanced TypeScript type definitions across the codebase. Created renewal.ts and api.ts,
      extracted inline types from services, and ensured all services import centralized types. 39 tests passed.
    learnings:
      - "Extracting inline interface definitions to dedicated files improves reuse."
      - "Re-exporting types keeps backward compatibility while centralizing definitions."
      - "API response types belong near related domain types."

  - task_id: TASK-009
    title: "Write unit tests for all modules"
    completed_at: "2025-11-22T20:35:00Z"
    outcome: success
    spec_id: null
    summary: |
      Completed comprehensive unit test coverage with mocked external APIs. Added book-repository.test.ts (17 tests)
      and raised total test count to 56. Coverage spans auth, charges, renewal, Aladin, storage, handlers, and utils.
    learnings:
      - "D1 mocks need careful setup; .all() may be called without .bind()."
      - "Factory helpers prevent mock state leakage."
      - "Per-test mock recreation avoids shared state issues."

  - task_id: TASK-010
    title: "Deploy and configure production environment"
    completed_at: "2025-11-22T20:40:00Z"
    outcome: success
    spec_id: null
    summary: |
      Verified production deployment on Cloudflare Workers with D1 database, secrets configured, cron set to 10:00 UTC,
      custom domain routing, Smart Placement, and observability enabled.
    learnings:
      - "Use wrangler d1 migrations list --remote to check prod schema."
      - "Cron verification via wrangler deployments list is essential."
      - "Secrets must be set before first scheduled run."

  - task_id: TASK-011
    title: "Post-build code audit and hardening recommendations"
    completed_at: "2025-11-22T06:28:59Z"
    outcome: success
    spec_id: SPEC-maintenance-001
    summary: |
      Completed repository audit identifying stale renewal persistence, unsecured manual trigger, missing retries/pagination,
      timezone issues, and HTTP usage for Aladin API.
    learnings:
      - "Renewal workflow fetched charges twice and missed persistence."
      - "Manual /trigger lacked authentication."
      - "Library client needed retries/timeouts/pagination."
      - "Date utilities needed KST awareness."
      - "Aladin client should use HTTPS."

  - task_id: TASK-012
    title: "Persist renewed due dates and avoid duplicate charge fetch"
    completed_at: "2025-11-22T06:32:40Z"
    outcome: success
    spec_id: SPEC-renewal-001
    summary: |
      Renewal workflow now reuses a single charges fetch and mutates charges with renewed due dates/counts before
      persistence. Tests ensure no duplicate fetches and accurate updates.
    learnings:
      - "Mutating shared charges keeps persistence accurate."
      - "Passing charges into renewal prevents redundant calls."

  - task_id: TASK-013
    title: "Secure manual /trigger endpoint"
    completed_at: "2025-11-22T06:34:32Z"
    outcome: success
    spec_id: SPEC-scheduler-001-sec
    summary: |
      Protected /trigger with Bearer secret, added tests for auth scenarios, and documented TRIGGER_SECRET in env/types.
    learnings:
      - "Shared secret is simplest immediate guard."
      - "waitUntil should be stubbed in tests to assert job enqueue."

  - task_id: TASK-014
    title: "Add retries, timeouts, and pagination to library client"
    completed_at: "2025-11-22T06:38:42Z"
    outcome: success
    spec_id: SPEC-auth-001
    summary: |
      Introduced fetchWithResilience with timeouts/backoff, login retries, paginated charges retrieval, and retryable
      renewals. Tests cover pagination and 5xx retry paths.
    learnings:
      - "Retry loops must cap attempts precisely."
      - "totalCount guards against silent truncation."

  - task_id: TASK-015
    title: "Make date calculations timezone-safe (KST)"
    completed_at: "2025-11-22T06:41:34Z"
    outcome: success
    spec_id: SPEC-renewal-001
    summary: |
      Date utilities now use timezone-aware day calculation (default KST), renewal/new-book logic accepts offset,
      and tests cover KST rollovers to prevent off-by-one errors.
    learnings:
      - "Shift by offset before day-flooring for host-independence."
      - "Offset ISO splitting is a robust date-string method."

  - task_id: TASK-016
    title: "Adjust /trigger to rely on Zero Trust (remove TRIGGER_SECRET)"
    completed_at: "2025-11-22T06:46:00Z"
    outcome: success
    spec_id: SPEC-scheduler-001-zt
    summary: |
      Removed in-worker secret enforcement; manual trigger now trusts Cloudflare Zero Trust. Cleaned env typings, wrangler
      vars, and tests accordingly.
    learnings:
      - "Delegate auth to Zero Trust to cut maintenance."
      - "Tests should focus on behavior when auth is external."

  - task_id: TASK-017
    title: "Add custom domain book.kadragon.work to worker routes"
    completed_at: "2025-11-22T00:30:00Z"
    outcome: success
    spec_id: SPEC-deploy-001
    summary: |
      Added custom domain route in wrangler.toml with trace comments linking to deployment needs.
    learnings:
      - "Routes array plus zone_name is sufficient when zone owned."
      - "Trace comments aid future audits."

  - task_id: TASK-018
    title: "Enable observability and Smart Placement"
    completed_at: "2025-11-22T00:55:00Z"
    outcome: success
    spec_id: SPEC-observability-001
    summary: |
      Enabled Smart Placement and configured log/trace sampling (logs 100%, traces 10%) in wrangler.toml with annotations.
    learnings:
      - "Observability supports separate head_sampling_rate for logs/traces."
      - "Smart placement reduces latency without code changes."

  - task_id: TASK-019
    title: "Build bookshelf frontend and expose books API"
    completed_at: "2025-11-22T17:10:00Z"
    outcome: success
    spec_id: SPEC-frontend-001
    summary: |
      Added bookshelf SPA served from Worker assets, /api/books with derived due status/daysLeft, SPA fallback, and React grid UI with search/filters.
    learnings:
      - "Derived fields simplify frontend."
      - "env.ASSETS.fetch + index fallback avoids html_handling quirks."
      - "Single package.json works with ESM Vite config."

  - task_id: TASK-020
    title: "Expose note metadata and UI CTA (stub)"
    completed_at: "2025-11-22T17:13:30Z"
    outcome: success
    spec_id: SPEC-notes-001
    summary: |
      Exposed noteCount/noteState fields in /api/books and surfaced a note CTA on cards, paving the way for persistence without DB changes yet.
    learnings:
      - "Include future-facing metadata early to avoid contract churn."
      - "CTA can exist without functionality if semantics are explicit."

  - task_id: TASK-021
    title: "Create and apply project favicon"
    completed_at: "2025-11-22T21:10:00Z"
    outcome: success
    spec_id: SPEC-frontend-001
    summary: "Designed and added a custom SVG favicon (open book gradient) and wired index.html."
    learnings:
      - "SVG favicons scale well and stay light."
      - "Vite copies public/ assets into dist automatically."

  - task_id: TASK-022
    title: "Enable Dependabot for GitHub Actions"
    completed_at: "2025-11-22T21:20:00Z"
    outcome: success
    spec_id: SPEC-ci-001
    summary: "Updated .github/dependabot.yml to monitor github-actions ecosystem weekly."
    learnings:
      - "Dependabot can track workflow action versions."

  - task_id: TASK-023
    title: "Implement full note-taking feature"
    completed_at: "2025-11-23T12:50:00Z"
    outcome: success
    spec_id: SPEC-notes-002
    summary: |
      Added notes table/migration, repository, CRUD API endpoints, and NoteModal UI with list/add/edit/delete, including accessibility/backdrop close and page ordering.
    learnings:
      - "Use DB ids for note routing/API calls to avoid charge_id coupling."
      - "Sort notes by page_number ascending for consistent reading flow."

  - task_id: TASK-024
    title: "Place note input at top of modal"
    completed_at: "2025-11-23T13:35:00Z"
    outcome: success
    spec_id: SPEC-notes-002
    summary: "Moved note creation control to the top of NoteModal; added layout helper and test (TEST-notes-ui-006)."
    learnings:
      - "Primary input should appear before history to cut scroll friction."

  - task_id: TASK-025
    title: "Remove '(작성 예정)' label when no notes"
    completed_at: "2025-11-23T13:37:30Z"
    outcome: success
    spec_id: SPEC-notes-002
    summary: "Hid placeholder label on cards when noteCount is zero; added guard helper and tests (TEST-notes-ui-007)."
    learnings:
      - "Tiny UX copies warrant regression tests for stability."

  - task_id: TASK-026
    title: "Simplify filters: remove author/minRenew/dueStatus"
    completed_at: "2025-11-23T13:44:30Z"
    outcome: success
    spec_id: SPEC-frontend-001
    summary: "Reduced bookshelf filters to search + loan-state; updated spec test and filterBooks helper with unit tests."
    learnings:
      - "Extract filtering logic into helpers to evolve UX safely."

  - task_id: TASK-027
    title: "Frontend UI improvements: pastel theme, read status, stats, note edit"
    completed_at: "2025-11-23T15:52:00Z"
    outcome: success
    spec_id: SPEC-frontend-001
    summary: |
      Added pastel design system, completion toggle UI, updated stats (대여중/독서중/완료/총), and fixed note edit scroll-to-top behavior.
    learnings:
      - "Pastel palette with contrast maintains readability."
      - "Progress-based stats better reflect reading state."

  - task_id: TASK-028
    title: "Send daily Telegram reading note"
    completed_at: "2025-11-23T16:13:00Z"
    outcome: success
    spec_id: SPEC-notes-telegram-001
    summary: |
      Added 12:00 KST cron to broadcast a reading note with lowest send_count selection, D1 send stats table, Telegram sender, secrets, and tests for selection/formatting/errors.
    learnings:
      - "Track send_count to avoid repeats."
      - "Cron branching via event.cron keeps workflows separate."

  - task_id: TASK-029
    title: "Frontend stats filters + default loan-state"
    completed_at: "2025-11-23T16:36:45Z"
    outcome: success
    spec_id: SPEC-frontend-001
    summary: |
      Stats now filter the grid (대여중/미완료/완료/총) with clickable cards; default loan-state preset set to '대출 중'. Tests added for stat filters and defaults.
    learnings:
      - "Shared defaults keep UI and tests aligned."

  - task_id: TASK-030
    title: "Create dedicated book detail page"
    completed_at: "2025-11-23T20:10:00Z"
    outcome: success
    spec_id: SPEC-book-detail-001
    summary: |
      Built BookDetailPage with two-column layout, GET /api/books/:id endpoint, React Router, full note CRUD, completion toggle, and responsive design. Added React Query cache invalidation.
    learnings:
      - "Use dbId for routing/API to avoid charge_id coupling."
      - "Responsive single/two-column layouts need shared style constants."

  - task_id: TASK-031
    title: "Allow notes to expand book detail page height (no inner scroll)"
    completed_at: "2025-11-23T21:06:00Z"
    outcome: success
    spec_id: SPEC-book-detail-001
    summary: "Removed inner scrollbar from notes list; long notes now extend page height. Added NOTES_LIST_SX constant and layout test."
    learnings:
      - "Avoid nested scroll areas for better keyboard/touch UX."

  - task_id: TASK-032
    title: "Use largest Aladin cover image"
    completed_at: "2025-11-23T21:33:00Z"
    outcome: success
    spec_id: SPEC-bookinfo-001
    summary: "Added Cover=Big to Aladin ItemLookUp, refreshed cover sync for missing images, and ensured repository updates cover/description."
    learnings:
      - "Requesting Cover=Big yields largest image size."

  - task_id: TASK-034
    title: "Mark returned books using charge histories"
    completed_at: "2025-11-23T14:30:00Z"
    outcome: success
    spec_id: SPEC-return-001
    summary: |
      Synced charge histories to mark returned books with discharge_date, matched by charge_id/ISBN, surfaced loanState=returned, and added migration 0006. Sync summary reports marked returns.
    learnings:
      - "Use charge_id first, ISBN fallback for robustness."
      - "Returned items should show daysLeft=0 and dueStatus=ok."

  - task_id: TASK-035
    title: "Format Telegram note broadcast with MarkdownV2"
    completed_at: "2025-11-26T05:54:45Z"
    outcome: success
    spec_id: SPEC-notes-telegram-002
    summary: "Telegram broadcast now uses MarkdownV2 with escaping, blockquoted content, parse_mode, and disabled previews; tests cover formatting/payload."
    learnings:
      - "Escape backslash, dot, dash for MarkdownV2 safety."

  - task_id: TASK-036
    title: "Refine MarkdownV2 broadcast formatting"
    completed_at: "2025-11-26T06:44:43Z"
    outcome: success
    spec_id: SPEC-notes-telegram-002
    summary: "Centralized escape regex, added author fallback, multiline quoting, missing-page handling, and expanded payload tests."
    learnings:
      - "Centralized regex reduces drift."
      - "Quote then escape for stable multiline rendering."

  - task_id: TASK-037
    title: "Tidy MarkdownV2 broadcast edge cases"
    completed_at: "2025-11-26T06:47:29Z"
    outcome: success
    spec_id: SPEC-notes-telegram-002
    summary: "Removed redundant author nullish coalescing, skipped empty content blockquotes, and added regression test for empty content."
    learnings:
      - "Conditionally render sections when data can be empty."

  - task_id: TASK-038
    title: "Add wrangler build to CI"
    completed_at: "2025-12-03T11:00:00Z"
    outcome: success
    spec_id: SPEC-maintenance-001
    summary: "Added wrangler build step to CI workflow to catch Worker build issues early."
    learnings:
      - "CI should mirror production build steps to detect compatibility issues."

  - task_id: TASK-039
    title: "Add React component rendering tests"
    completed_at: "2025-12-11T13:25:00Z"
    outcome: success
    spec_id: SPEC-ci-002
    summary: "Installed @testing-library/react/jsdom, configured Vitest workspaces, and added App smoke test to catch React/ReactDOM mismatches in CI."
    learnings:
      - "Separate worker and frontend test environments avoid DOM errors in Node tests."

  - task_id: TASK-040
    title: "Compact governance and task registries"
    completed_at: "2025-12-11T14:15:00Z"
    outcome: success
    spec_id: SPEC-governance-001
    summary: "Compacted .tasks and .governance registries: cleared backlog of completed items, normalized done.yaml, reset current.yaml, and added governance spec for traceability."
    learnings:
      - "Keep backlog strictly pending to avoid confusion."
      - "Normalize YAML structure to preserve machine readability."

  - task_id: TASK-041
    title: "Add integration tests for search handler"
    completed_at: "2025-12-11T13:53:30Z"
    outcome: success
    spec_id: SPEC-search-001
    summary: |
      Added comprehensive integration tests for handleSearchBooksApi covering parameter validation, error handling,
      API failures, and response formatting. Created SPEC-search-001 with GWT acceptance criteria.
      All 18 tests passing (122 total across project).
    learnings:
      - "Mock vi.fn with async beforeEach for proper module import isolation"
      - "Test parameter validation edge cases (empty strings, NaN, boundary values)"
      - "Verify response headers (Content-Type, Cache-Control) in API tests"
      - "Include tests for optional field handling (null author, missing ISBN)"

  - task_id: TASK-042
    title: "Fix SearchBooksPage based on PR review feedback"
    completed_at: "2025-12-11T14:04:30Z"
    outcome: success
    spec_id: SPEC-search-001
    summary: |
      Applied PR #49 review feedback from gemini-code-assist[bot]:
      1. Fixed Material-UI TextField to use InputProps instead of slotProps.input for startAdornment/endAdornment
      2. Added validatePageParam helper with URL parameter validation (NaN, zero, negative -> default 1)
      3. Created SearchBooksPage.test.ts with 8 unit tests for validation edge cases
      All 130 tests passing (8 new validation tests added).
    learnings:
      - "Material-UI v5+: slotProps.input targets native input, InputProps targets Input component"
      - "Always validate user-supplied URL parameters with explicit NaN and boundary checks"
      - "Extract validation logic to pure helper functions for testability"
      - "Defensive programming prevents crashes from malicious/invalid URL manipulation"
