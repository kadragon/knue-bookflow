# Completed Tasks
# Tasks are moved here after completion with results and learnings

completed_tasks: []

# Example of completed task:
# - task_id: TASK-001
#   title: "Initialize Cloudflare Workers project"
#   completed_at: "2025-01-22T12:00:00Z"
#   outcome: success
#   summary: "Project initialized with all configurations"
#   learnings:
#     - "D1 binding requires specific wrangler.toml format"

- task_id: TASK-011
  title: "Post-build code audit and hardening recommendations"
  completed_at: "2025-11-22T06:28:59Z"
  outcome: success
  spec_id: SPEC-maintenance-001
  summary: |
    Completed a repository-wide audit after the first build. Identified stale
    renewal persistence, unsecured manual trigger endpoint, lack of retries and
    pagination in library client, timezone-sensitive date logic, and HTTP usage
    for Aladin API requests.
  learnings:
    - "Renewal workflow fetches charges twice and fails to persist renewed due dates/renewCnt."
    - "Manual /trigger endpoint is unauthenticated, enabling arbitrary runs."
    - "Library API calls need retries, timeouts, and pagination to avoid silent data loss."
    - "Date utilities assume local timezone; should be KST-aware."
    - "Aladin client should use HTTPS to avoid MITM and mixed-content issues."

- task_id: TASK-012
  title: "Persist renewed due dates and avoid duplicate charge fetch"
  completed_at: "2025-11-22T06:32:40Z"
  outcome: success
  spec_id: SPEC-renewal-001
  summary: |
    Avoided duplicate charges fetch by letting renewal reuse pre-fetched data and mutated
    charges in-memory to reflect renewed due dates/renew counts before persistence. Updated
    workflow to call checkAndRenewBooks with existing charges; added tests to verify no extra
    fetch and that charge objects are updated.
  learnings:
    - "Mutating the shared charges array after renewals keeps downstream persistence accurate."
    - "Passing charges into renewal function prevents redundant API calls."

- task_id: TASK-013
  title: "Secure manual /trigger endpoint"
  completed_at: "2025-11-22T06:34:32Z"
  outcome: success
  spec_id: SPEC-scheduler-001-sec
  summary: |
    Protected the manual /trigger endpoint with Bearer secret, added tests for missing/invalid/valid
    secrets, and documented TRIGGER_SECRET in env/types and wrangler vars. Workflow only starts when
    Authorization matches.
  learnings:
    - "Using a simple shared secret is the fastest guard; could swap to HMAC or SignedURL later."
    - "Tests must stub waitUntil to assert the job is enqueued without running network calls."

- task_id: TASK-014
  title: "Add retries, timeouts, and pagination to library client"
  completed_at: "2025-11-22T06:38:42Z"
  outcome: success
  spec_id: SPEC-auth-001
  summary: |
    Added resilience to library client: fetchWithResilience with timeouts/backoff, login retries,
    paginated charges retrieval, and retryable renewals. Tests cover pagination and 5xx retry.
  learnings:
    - "Retry loops must cap attempts precisely to avoid exhausting fetch mocks."
    - "Pagination combined with totalCount guards against silent truncation."

- task_id: TASK-015
  title: "Make date calculations timezone-safe (KST)"
  completed_at: "2025-11-22T06:41:34Z"
  outcome: success
  spec_id: SPEC-renewal-001
  summary: |
    Date utilities now use a timezone-aware day calculation (default KST, overrideable),
    renewal/new-book logic accepts offset, and tests cover KST day rollovers. This prevents
    off-by-one around UTC/KST midnights.
  learnings:
    - "Shifting by offset before day-flooring keeps logic independent of host timezone."
    - "Simple offset-shifted ISO splitting is a robust way to get date strings."

- task_id: TASK-016
  title: "Adjust /trigger to rely on Zero Trust (remove TRIGGER_SECRET)"
  completed_at: "2025-11-22T06:46:00Z"
  outcome: success
  spec_id: SPEC-scheduler-001-zt
  summary: |
    Removed in-worker Bearer secret requirement for /trigger; security will be enforced via
    Cloudflare Zero Trust/Access. Cleaned up env typings, wrangler vars, and secret tests.
  learnings:
    - "When Zero Trust guards the route, duplicate in-worker secrets add maintenance overhead."
    - "Manual trigger tests should focus on behavior, not auth, when auth is delegated."

- task_id: TASK-017
  title: "Add custom domain book.kadragon.work to worker routes"
  completed_at: "2025-11-22T00:30:00Z"
  outcome: success
  spec_id: SPEC-deploy-001
  summary: |
    Added a custom domain route for book.kadragon.work in wrangler.toml with traceability
    comments so deployments map the Worker to the requested hostname.
  learnings:
    - "Routes array with zone_name is sufficient when account has the zone; no code changes needed."
    - "Trace comments in config aid future auditing of domain mappings."

- task_id: TASK-018
  title: "Enable observability and Smart Placement"
  completed_at: "2025-11-22T00:55:00Z"
  outcome: success
  spec_id: SPEC-observability-001
  summary: |
    Enabled Smart Placement and configured observability with 100% log sampling and 10% trace sampling
    via wrangler.toml, with trace annotations for auditing.
  learnings:
    - "wrangler observability supports separate head_sampling_rate for logs and traces."
    - "Placement block with mode=smart lowers latency without code changes."

- task_id: TASK-019
  title: "Build bookshelf frontend and expose books API"
  completed_at: "2025-11-22T17:10:00Z"
  outcome: success
  spec_id: SPEC-frontend-001
  summary: |
    Added a bookshelf SPA served directly from the Worker assets binding, exposed /api/books with
    derived due status/daysLeft, implemented SPA fallback, and built a React-based grid UI with search
    and filters for author, due status, renew count, and loan state.
  learnings:
    - "Returning derived fields (dueStatus, daysLeft) keeps the frontend simple and predictable."
    - "Assets fallback via env.ASSETS.fetch plus index.html avoids html_handling quirks in wrangler."
    - "Using a single package.json still supports Vite builds when config is ESM (.mts)."

- task_id: TASK-020
  title: "Expose note metadata and UI CTA (stub)"
  completed_at: "2025-11-22T17:13:30Z"
  outcome: success
  spec_id: SPEC-notes-001
  summary: |
    Exposed noteCount/noteState fields from /api/books and surfaced a note CTA on cards to pave the way
    for future note persistence without DB changes yet. Kept values stubbed (0/not_started) pending persistence design.
  learnings:
    - "Including note metadata in the API now avoids a future contract change when persistence arrives."
    - "CTA can be present without functionality as long as semantics are explicit (not_started)."

- task_id: TASK-008
  title: "Add TypeScript type definitions"
  completed_at: "2025-11-22T20:20:00Z"
  outcome: success
  spec_id: null
  summary: |
    Consolidated and enhanced TypeScript type definitions across the codebase. Created new type files
    for renewal types (renewal.ts) and API response types (api.ts). Extracted inline types from services
    into dedicated type modules and ensured all services import from centralized types. All 39 tests pass.
  learnings:
    - "Extracting inline interface definitions to dedicated type files improves discoverability and reuse."
    - "Re-exporting types from services maintains backward compatibility while centralizing definitions."
    - "API response types (BookViewModel, DueStatus) belong with related types rather than in handlers."

- task_id: TASK-009
  title: "Write unit tests for all modules"
  completed_at: "2025-11-22T20:35:00Z"
  outcome: success
  spec_id: null
  summary: |
    Completed comprehensive unit test coverage for all modules. Created book-repository.test.ts with
    17 tests for D1 database operations (saveBook, findByChargeId, findByIsbn, findAll, logRenewal,
    getRenewalLogs, createBookRecord). Total test count increased from 39 to 56 tests, all passing.
    Coverage includes auth, charges, renewal, Aladin, storage, handlers, and utils modules.
  learnings:
    - "D1 database operations require careful mock setup; .all() may be called directly without .bind()."
    - "Using type-safe mock factories (createMockCharge, createMockBookInfo) improves test maintainability."
    - "Re-creating mocks per test with mockReturnValue avoids state leakage between tests."

- task_id: TASK-010
  title: "Deploy and configure production environment"
  completed_at: "2025-11-22T20:40:00Z"
  outcome: success
  spec_id: null
  summary: |
    Verified production deployment on Cloudflare Workers. D1 database (knue-bookflow-db) provisioned
    with migrations applied (books, renewal_logs tables). All three secrets configured (LIBRARY_USER_ID,
    LIBRARY_PASSWORD, ALADIN_API_KEY). Cron trigger set for 10:00 UTC daily. Custom domain
    book.kadragon.work routed. Smart Placement and observability (100% logs, 10% traces) enabled.
  learnings:
    - "wrangler d1 migrations list shows local status; use --remote for production state."
    - "D1 tables include internal _cf_KV and d1_migrations for Cloudflare management."
    - "Verify deployment with wrangler deployments list and d1 execute for table checks."

- task_id: TASK-021
  title: "Create and apply project favicon"
  completed_at: "2025-11-22T21:10:00Z"
  outcome: success
  spec_id: SPEC-frontend-001
  summary: |
    Designed and added a custom SVG favicon representing an open book with the project's
    gradient theme. Updated index.html to serve it.
  learnings:
    - "SVG favicons are lightweight and scale well."
    - "Vite automatically copies files from public/ to dist/ during build."

- task_id: TASK-022
  title: "Enable Dependabot for GitHub Actions"
  completed_at: "2025-11-22T21:20:00Z"
  outcome: success
  spec_id: SPEC-ci-001
  summary: |
    Updated .github/dependabot.yml to include the "github-actions" package ecosystem
    with weekly interval.
  learnings:
    - "Dependabot can monitor GitHub Actions workflow files for action version updates."

- task_id: TASK-024
  title: "Place note input at top of modal"
  completed_at: "2025-11-23T13:35:00Z"
  outcome: success
  spec_id: SPEC-notes-002
  summary: |
    Reordered the NoteModal so the add/edit note control sits at the top, ensuring users
    can start writing without scrolling past long histories. Added a small layout helper
    with a unit test (TEST-notes-ui-006) and tweaked styles to keep spacing consistent.
  learnings:
    - "Keep primary input affordances at the top of modals to minimize scroll friction."
    - "A tiny ordering helper plus test locks in UX expectations without heavy UI harnesses."

- task_id: TASK-025
  title: "Remove '(작성 예정)' label when no notes"
  completed_at: "2025-11-23T13:37:30Z"
  outcome: success
  spec_id: SPEC-notes-002
  summary: |
    Hid the placeholder "(작성 예정)" copy on book cards when noteCount is zero. Added a
    guard helper with unit tests (TEST-notes-ui-007) to keep the label from reappearing.
  learnings:
    - "Small text changes benefit from a dedicated helper + test to prevent regressions."

- task_id: TASK-026
  title: "Simplify filters: remove author/minRenew/dueStatus"
  completed_at: "2025-11-23T13:44:30Z"
  outcome: success
  spec_id: SPEC-frontend-001
  summary: |
    Removed author, due-status, and minimum-renew filters from the bookshelf UI and logic,
    leaving search and loan-state filters only. Updated spec (TEST-frontend-004) and added a
    filterBooks helper with unit tests to lock the new behavior.
  learnings:
    - "Extracting filtering into a helper makes UX changes safer to iterate." 
