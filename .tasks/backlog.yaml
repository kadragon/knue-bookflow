# Task Backlog - KNUE BookFlow
# Priority: 1 (highest) to 5 (lowest)

tasks:
  - task_id: TASK-034
    title: "Mark returned books using charge histories"
    description: |
      Extend sync to fetch charge histories, match returned items by charge_id/ISBN,
      store discharge_date in DB, and surface loanState=returned so returned books
      drop out of the active loan list while remaining viewable in history.
    priority: 1
    spec_id: SPEC-return-001
    status: done
    test_refs:
      - TEST-return-sync-001
      - TEST-return-sync-002
      - TEST-return-sync-003
      - TEST-return-sync-004
      - TEST-return-sync-005
    acceptance_criteria:
      - Sync fetches charge histories with pagination and auth
      - Returned books matched by charge_id first, ISBN fallback
      - Books updated with discharge_date and loanState returned
      - Default on-loan list hides returned books; loanState filter can show them
      - Sync summary reports how many books were marked returned
    estimated_complexity: medium

  - task_id: TASK-031
    title: "Allow notes to expand book detail page height (no inner scroll)"
    description: |
      On the book detail page, when many reading notes exist, the notes panel shows
      its own scrollbar and the overall page height stays fixed. Change the layout
      so the notes list grows the overall page height (standard page scrolling)
      instead of trapping scroll inside the notes area. Keep the layout responsive.
    priority: 1
    spec_id: SPEC-book-detail-001
    status: done
    acceptance_criteria:
      - Notes panel does not create its own scrolling container on desktop or mobile
      - Long notes list increases full page height; browser scrollbar reflects total content
      - Layout remains responsive (two columns desktop, stacked mobile)
      - Existing note CRUD interactions remain functional
    estimated_complexity: low

  - task_id: TASK-028
    title: "Send daily Telegram reading note"
    description: |
      Add a daily 12:00 KST cron that sends one reading note to Telegram. Pick a
      random note among those with the lowest send count to avoid repeats, format
      as "책명 - 작가\np.xx\n내용", and track send counts.
    priority: 1
    spec_id: SPEC-notes-telegram-001
    status: done
    acceptance_criteria:
      - New spec SPEC-notes-telegram-001 defines cron, selection, formatting, and telemetry
      - D1 schema stores per-note send counts and last sent timestamp
      - Telegram API call uses bot token/chat id secrets; errors handled gracefully
      - Cron added for 12:00 KST (03:00 UTC) without affecting existing cron
      - Tests cover selection fairness, formatting, and error handling
    estimated_complexity: medium

  - task_id: TASK-021
    title: "Library-DB sync feature"
    description: |
      Synchronize all currently borrowed books from the library with the D1 database.
      This ensures books that were missed during daily sync (due to errors or timing)
      are properly registered with Aladin metadata.
    priority: 1
    spec_id: SPEC-sync-001
    status: done
    test_refs:
      - TEST-sync-001
      - TEST-sync-002
      - TEST-sync-003
      - TEST-sync-004
      - TEST-sync-005
      - TEST-sync-006
    acceptance_criteria:
      - POST /api/books/sync endpoint implemented
      - Fetch all charges from library API
      - Identify books missing from DB
      - Add missing books with Aladin metadata
      - Update existing books with latest charge data
      - Return sync summary (added/updated/unchanged counts)
      - Frontend sync button
      - Tests passing (56 total)
    estimated_complexity: medium

  - task_id: TASK-022
    title: "Consolidate shared types between frontend and backend"
    description: |
      Create a shared types package to eliminate duplicate type definitions
      between frontend and backend. Currently SyncSummary, SyncResponse, and
      other API types are defined in both places, leading to potential
      inconsistencies and maintenance overhead.
    priority: 3
    spec_id: null
    status: pending
    acceptance_criteria:
      - Create shared types directory or package
      - Move common API response types to shared location
      - Update frontend and backend imports
      - Ensure build systems work with shared types
      - Remove duplicate type definitions
    estimated_complexity: medium
    notes: |
      PR review feedback from gemini-code-assist suggested this improvement.
      Requires careful consideration of build system configuration for both
      Vite (frontend) and Wrangler (backend).

  - task_id: TASK-011
    title: "Post-build code audit and hardening recommendations"
    description: |
      Review the completed build, analyze the codebase for defects, risks,
      and improvement opportunities, and propose actionable follow-ups.
    priority: 1
    spec_id: SPEC-maintenance-001
    status: pending
    acceptance_criteria:
      - Audit findings documented with severity and file references
      - Recommendations mapped to relevant specs or new tasks
      - Follow-up backlog items created as needed
    estimated_complexity: medium

  - task_id: TASK-001
    title: "Initialize Cloudflare Workers project"
    description: |
      Set up the project with Wrangler, TypeScript configuration,
      and necessary dependencies.
    priority: 1
    spec_id: null
    status: pending
    acceptance_criteria:
      - wrangler.toml configured with D1 binding and cron trigger
      - TypeScript configured with strict mode
      - Package.json with required dependencies
      - Basic project structure created
    estimated_complexity: low

  - task_id: TASK-002
    title: "Implement library authentication module"
    description: |
      Create a service to authenticate with KNUE library Pyxis API
      and manage session tokens.
    priority: 1
    spec_id: SPEC-auth-001
    status: pending
    test_refs:
      - TEST-auth-001
      - TEST-auth-002
      - TEST-auth-003
      - TEST-auth-004
      - TEST-auth-005
    acceptance_criteria:
      - Login function with credential handling
      - Session cookie extraction from response
      - Access token management
      - Error handling for auth failures
    estimated_complexity: medium

  - task_id: TASK-003
    title: "Implement charges retrieval service"
    description: |
      Create service to fetch current borrowed books list
      from library API.
    priority: 1
    spec_id: SPEC-charges-001
    status: pending
    dependencies:
      - TASK-002
    test_refs:
      - TEST-charges-001
      - TEST-charges-002
      - TEST-charges-003
      - TEST-charges-004
      - TEST-charges-005
    acceptance_criteria:
      - Fetch charges with authenticated session
      - Parse response into typed data structure
      - Handle empty results
    estimated_complexity: medium

  - task_id: TASK-004
    title: "Implement book renewal logic"
    description: |
      Create service to identify eligible books and process
      automatic renewals.
    priority: 1
    spec_id: SPEC-renewal-001
    status: pending
    dependencies:
      - TASK-003
    test_refs:
      - TEST-renewal-001
      - TEST-renewal-002
      - TEST-renewal-003
      - TEST-renewal-004
      - TEST-renewal-005
      - TEST-renewal-006
    acceptance_criteria:
      - Filter books by renewal criteria
      - Call renewal API for eligible books
      - Handle success and failure responses
      - Log all renewal attempts
    estimated_complexity: medium

  - task_id: TASK-005
    title: "Implement Aladin API integration"
    description: |
      Create service to fetch book metadata from Aladin Open API
      for newly borrowed books.
    priority: 2
    spec_id: SPEC-bookinfo-001
    status: pending
    dependencies:
      - TASK-003
    test_refs:
      - TEST-bookinfo-001
      - TEST-bookinfo-002
      - TEST-bookinfo-003
      - TEST-bookinfo-004
      - TEST-bookinfo-005
    acceptance_criteria:
      - Detect new books by charge date
      - Call Aladin API with ISBN
      - Parse book metadata
      - Handle missing books gracefully
    estimated_complexity: medium

  - task_id: TASK-006
    title: "Set up D1 database and repository"
    description: |
      Create D1 database schema and implement data access layer
      for book records.
    priority: 2
    spec_id: SPEC-storage-001
    status: pending
    dependencies:
      - TASK-001
    test_refs:
      - TEST-storage-001
      - TEST-storage-002
      - TEST-storage-003
      - TEST-storage-004
      - TEST-storage-005
    acceptance_criteria:
      - D1 database created and configured
      - Schema migrations defined
      - Repository class with CRUD operations
      - Duplicate prevention logic
    estimated_complexity: medium

  - task_id: TASK-012
    title: "Persist renewed due dates and avoid duplicate charge fetch"
    description: |
      Align the renewal workflow so charges are fetched once, renewal outcomes
      update persisted due dates/renew counts, and stale data is avoided.
    priority: 1
    spec_id: SPEC-renewal-001
    status: done
    dependencies:
      - TASK-004
    acceptance_criteria:
      - Workflow uses a single source of charges for renewals and persistence
      - Renewed dueDate and renewCnt are persisted to D1
      - No redundant API calls for charges
    estimated_complexity: medium

  - task_id: TASK-013
    title: "Secure manual /trigger endpoint"
    description: |
      Protect the manual trigger HTTP endpoint with authentication/authorization
      to prevent unauthorized job execution.
    priority: 1
    spec_id: SPEC-scheduler-001
    status: done
    acceptance_criteria:
      - /trigger requires a shared secret or auth mechanism
      - Unauthorized requests receive 401/403
      - Tests cover happy path and rejection cases
    estimated_complexity: low

  - task_id: TASK-014
    title: "Add retries, timeouts, and pagination to library client"
    description: |
      Improve resilience of login/charges/renewal calls with bounded retries,
      request timeouts, and pagination to handle more than 20 loans.
    priority: 2
    spec_id: SPEC-auth-001
    status: done
    acceptance_criteria:
      - Fetch calls use AbortController-based timeouts
      - Retry with exponential backoff on transient errors (5xx/ETIMEDOUT)
      - Charges retrieval supports pagination for >20 items
      - Unit tests cover retry/timeout behavior
    estimated_complexity: medium

  - task_id: TASK-015
    title: "Make date calculations timezone-safe (KST)"
    description: |
      Ensure due-date comparisons and 'today' detection use KST to avoid
      off-by-one errors around midnight UTC.
    priority: 2
    spec_id: SPEC-renewal-001
    status: done
    acceptance_criteria:
      - Date utilities accept timezone or use ENVIRONMENT/KST offset
      - Renewal candidate selection validated with KST-based tests
      - identifyNewBooks respects chargeDate in KST
    estimated_complexity: low

  - task_id: TASK-016
    title: "Adjust /trigger to rely on Zero Trust (remove TRIGGER_SECRET)"
    description: |
      Remove in-worker shared secret enforcement for /trigger; leave security to
      Cloudflare Zero Trust Access while keeping manual trigger functional.
    priority: 2
    spec_id: SPEC-scheduler-001-zt
    status: done
    acceptance_criteria:
      - /trigger works without TRIGGER_SECRET
      - TRIGGER_SECRET removed from env typings and wrangler vars
      - Tests updated to reflect no-secret behavior
    estimated_complexity: low

  - task_id: TASK-017
    title: "Add custom domain book.kadragon.work to worker routes"
    description: |
      Configure the Worker to serve on the custom hostname book.kadragon.work
      by adding the route to wrangler.toml and ensuring deployment recognizes it.
    priority: 1
    spec_id: SPEC-deploy-001
    status: done
    acceptance_criteria:
      - wrangler.toml includes a route for book.kadragon.work/*
      - Route configuration is traceable to SPEC-deploy-001 and TASK-017
      - Deployment instructions reflect the new domain
    estimated_complexity: low

  - task_id: TASK-018
    title: "Enable observability and Smart Placement"
    description: |
      Configure full log sampling, 10% trace sampling, and Smart Placement in wrangler.toml
      for better diagnostics and latency.
    priority: 1
    spec_id: SPEC-observability-001
    status: done
    acceptance_criteria:
      - wrangler.toml sets logs head_sampling_rate to 1.0
      - wrangler.toml sets traces head_sampling_rate to 0.1
      - wrangler.toml enables placement mode smart
    estimated_complexity: low

  - task_id: TASK-007
    title: "Implement scheduled workflow handler"
    description: |
      Create the main cron handler that orchestrates the entire
      renewal workflow.
    priority: 1
    spec_id: SPEC-scheduler-001
    status: pending
    dependencies:
      - TASK-002
      - TASK-003
      - TASK-004
      - TASK-005
      - TASK-006
    test_refs:
      - TEST-scheduler-001
      - TEST-scheduler-002
      - TEST-scheduler-003
      - TEST-scheduler-004
      - TEST-scheduler-005
    acceptance_criteria:
      - Cron handler entry point
      - Sequential workflow execution
      - Error handling at each step
      - Execution summary logging
    estimated_complexity: high

  - task_id: TASK-008
    title: "Add TypeScript type definitions"
    description: |
      Create comprehensive type definitions for all data structures
      used in the application.
    priority: 2
    spec_id: null
    status: done
    dependencies:
      - TASK-001
    acceptance_criteria:
      - Types for library API responses
      - Types for Aladin API responses
      - Types for D1 database models
      - Types for Worker environment bindings
    estimated_complexity: low

  - task_id: TASK-009
    title: "Write unit tests for all modules"
    description: |
      Implement comprehensive unit tests with mocked external APIs.
    priority: 2
    spec_id: null
    status: done
    dependencies:
      - TASK-002
      - TASK-003
      - TASK-004
      - TASK-005
      - TASK-006
    acceptance_criteria:
      - Tests for auth module
      - Tests for charges module
      - Tests for renewal module
      - Tests for Aladin module
      - Tests for storage module
      - Mocked API responses
    estimated_complexity: high

  - task_id: TASK-010
    title: "Deploy and configure production environment"
    description: |
      Deploy Worker to Cloudflare, configure secrets, and verify
      cron trigger execution.
    priority: 3
    spec_id: null
    status: done
    dependencies:
      - TASK-007
      - TASK-009
    acceptance_criteria:
      - Worker deployed to Cloudflare
      - Secrets configured (API keys, credentials)
      - D1 database provisioned
      - Cron trigger verified in dashboard
      - First successful execution confirmed
    estimated_complexity: medium
